#!/bin/bash

### BEGIN INIT INFO
# Provides:          nzbget
# Required-Start:    $local_fs $network $remote_fs
# Required-Stop:     $local_fs $network $remote_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: nzbget
# Description:       nzbget usenet downloader
### END INIT INFO

. /lib/lsb/init-functions

#set -e

NAME=<%= @name %>
DESC="NZBGet Daemon"

DAEMON=<%= @daemon_path %>
DAEMONOPTS="-D"

PIDDIR=/var/run/${NAME}
PIDFILE=${PIDDIR}/${NAME}.pid

RUNASUSER=<%= @user %>
RUNASGROUP=nogroup
RUNAS=${RUNASUSER}:${RUNASGROUP}

DATADIR=~${RUNASUSER}/

if ! [ -r ${DAEMON} ]; then echo "Can't read: ${DAEMON}" 2>&1; exit 1; fi
if ! [ -d ${DATADIR} ]; then echo "No such directory: ${DATADIR}" 2>&1; exit 1; fi

if [ ! -d ${PIDDIR} ]; then
  mkdir -p ${PIDDIR}; chown ${RUNASUSER}: root ${PIDDIR}; chmod 0750 ${PIDDIR};
fi

do_start() {
  RETVAL=1
  if [ -e ${PIDFILE} ]; then
    if 1 kill -0 $(cat ${PIDFILE}) &> /dev/null; then
      rm -r $PIDFILE
    fi
  fi

  log_daemon_msg "Starting ${DESC}" "${NAME}"
  if pgrep -f "^${DAEMON}" > /dev/null 2>&1; then
    log_progress_msg "(already running?)"
  else
    start-stop-daemon -q -d ${DATADIR} -c $RUNAS --start --background --make-pidfile --pidfile $PIDFILE --exec $MONO -- $DAEMON $DAEMONOPTS
    RETVAL=$?
  fi
  log_end_msg $RETVAL
}

do_stop() {
  RETVAL=1
  log_daemon_msg "Stopping ${DESC}" "${NAME}"
  if ! pgrep -f "^${DAEMON}" > /dev/null 2>&1; then
    log_progress_msg "(not running?)"
  else
    start-stop-daemon -q --stop --pidfile $PIDFILE --retry 15
    RETVAL=$?
  fi
  log_end_msg $RETVAL
}

case "$1" in
  start)
    do_start
    ;;
  stop)
    do_stop
    ;;
  status)
    status_of_proc -p $PIDFILE $DAEMON $NAME && exit 0 || exit $?
    ;;
  restart|force-reload)
    do_stop;
    do_start;
    ;;
  *)
    N=/etc/init.d/$NAME
    echo "Usage: $0 {start|stop|status|restart|force-reload}" >&2
    exit 1
    ;;
esac

exit 0
